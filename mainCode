Sub resetNamedRange()
Dim wsF As Worksheet
Dim wsD As Worksheet
Dim WorksheetName_Main As String
Dim WorksheetName_Data As String
Dim lEndRow As Long
Dim NamedRange_Name As String
Dim rng As Range
Dim lb As OLEObject

'''''
WorksheetName_Main = "Form"
WorksheetName_Data = "Data"
NamedRange_Name = "Example"
'''''

Set wsF = Worksheets(WorksheetName_Main)
Set wsD = Worksheets(WorksheetName_Data)
Set lb = wsF.OLEObjects("ListBox1")
lEndRow = wsD.Cells(wsD.Rows.Count, 1).End(xlUp).Row
Set rng = Range(wsD.Cells(2, 1), wsD.Cells(lEndRow, 1))

On Error Resume Next
ThisWorkbook.Names(InvRange).Delete
On Error GoTo 0

ThisWorkbook.Names.Add Name:=NamedRange_Name, RefersTo:=rng

lb.ListFillRange = NamedRange_Name

MsgBox "The stock list has been updated!"

End Sub


' Function to validate date format dd/mm/yyyy
Function IsValidDate(dateStr As String) As Boolean
Dim parts() As String
Dim day As Integer
Dim month As Integer
Dim year As Integer

On Error GoTo InvalidDate
parts = Split(dateStr, "/")

If UBound(parts) <> 2 Then
IsValidDate = False
Exit Function
End If

day = CInt(parts(0))
month = CInt(parts(1))
year = CInt(parts(2))

If day < 1 Or day > 31 Or month < 1 Or month > 12 Then
IsValidDate = False
Exit Function
End If

If month = 2 Then
If (year Mod 4 = 0 And year Mod 100 <> 0) Or (year Mod 400 = 0) Then
    If day > 29 Then IsValidDate = False: Exit Function
Else
    If day > 28 Then IsValidDate = False: Exit Function
End If
ElseIf month = 4 Or month = 6 Or month = 9 Or month = 11 Then
If day > 30 Then IsValidDate = False: Exit Function
End If

IsValidDate = True
Exit Function

InvalidDate:
IsValidDate = False
End Function

Sub setDate()
Dim wsD As Worksheet
Dim WorksheetName_Main As String
Dim WorksheetName_Data As String
Dim tbDate As OLEObject
Dim dDate As Date
'''''
WorksheetName_Main = "Form"
'''''
Set wsF = Worksheets(WorksheetName_Main)
Set tbDate = wsF.OLEObjects("TextBoxDate")
dDate = Date
tbDate.Object.Value = Format(dDate, "dd/mm/yyyy")
End Sub

Sub stockChange()
Dim wsF As Worksheet
Dim wsD As Worksheet
Dim WorksheetName_Main As String
Dim WorksheetName_Data As String
Dim tbStock As OLEObject
Dim tbDate As OLEObject
Dim tbName As OLEObject
Dim tbAmount As OLEObject
Dim lb As OLEObject
Dim lEndRow As Long
Dim currentStock As Double
Dim amountToAdd As Double
Dim rngStock As Range
Dim vTemp As Variant
Dim sShape As String

'''''
WorksheetName_Main = "Form"
WorksheetName_Data = "Data"
'''''

Set wsF = Worksheets(WorksheetName_Main)
Set wsD = Worksheets(WorksheetName_Data)

sShape = Application.Caller

Debug.Print sShape

Set lb = wsF.OLEObjects("ListBox1")
Set tbDate = wsF.OLEObjects("TextBoxDate")
Set tbName = wsF.OLEObjects("TextBoxName")
Set tbAmount = wsF.OLEObjects("TextBoxAmount")
Set tbStock = wsF.OLEObjects("TextBoxStock")

If lb.Object.ListIndex = -1 Then
MsgBox "Please select an item.", vbExclamation
Exit Sub
End If

If tbAmount.Object.Value = "" Then
MsgBox "Please enter an amount.", vbExclamation
Exit Sub
End If

If tbDate.Object.Value = "" Then
MsgBox "Please enter a date.", vbExclamation
Exit Sub
End If

If tbName.Object.Value = "" Then
MsgBox "Please enter a name.", vbExclamation
Exit Sub
End If

If Not IsDate(tbDate.Object.Value) Or Not IsValidDate(tbDate.Object.Value) Then
MsgBox "Please enter a valid date in the format dd/mm/yyyy.", vbExclamation
Exit Sub
End If

currentStock = Val(tbStock.Object.Value)

If sShape = "Shape_Increase" Then
amountToAdd = Val(tbAmount.Object.Value)
Else
amountToAdd = Val(tbAmount.Object.Value) * -1
End If

lEndRow = wsD.Cells(wsD.Rows.Count, 4).End(xlUp).Row + 1

wsD.Cells(lEndRow, 4).Value = tbDate.Object.Value          ' Date
wsD.Cells(lEndRow, 5).Value = lb.Object.Value              ' Selected item from ListBox
wsD.Cells(lEndRow, 6).Value = amountToAdd                  ' Amount
wsD.Cells(lEndRow, 7).Value = tbName.Object.Value          ' Name
wsD.Cells(lEndRow, 8).Value = currentStock                 ' Current stock
wsD.Cells(lEndRow, 9).Value = currentStock + amountToAdd   ' Updated stock
wsD.Cells(lEndRow, 10).Value = Now()                       ' Timestamp

lEndRow = wsD.Cells(wsD.Rows.Count, 1).End(xlUp).Row
Set rngStock = wsD.Range(wsD.Cells(1, 1), wsD.Cells(lEndRow, 1))

vTemp = Application.Match(lb.Object.Value, rngStock, 0)

wsD.Cells(vTemp, 2).Value = wsD.Cells(vTemp, 2).Value + amountToAdd

vTemp = lb.Object.Value

Application.ScreenUpdating = False
tbDate.Object.Value = ""
tbName.Object.Value = ""
tbAmount.Object.Value = ""
tbStock.Object.Value = ""
lb.Object.ListIndex = -1
Application.ScreenUpdating = True

If sShape = "Shape_Increase" Then
MsgBox "Stock increase recorded successfully!" & vbCrLf & vTemp & ": " & amountToAdd, vbInformation
Else
MsgBox "Stock decrease recorded successfully!" & vbCrLf & vTemp & ": " & amountToAdd, vbInformation
End If

End Sub
